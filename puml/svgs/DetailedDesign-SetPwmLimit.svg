<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="1952px" preserveAspectRatio="none" style="width:1319px;height:1952px;background:#FFFFFF;" version="1.1" viewBox="0 0 1319 1952" width="1319px" zoomAndPan="magnify"><defs/><g><ellipse cx="514.5" cy="20" fill="#222222" rx="10" ry="10" style="stroke:#222222;stroke-width:1.0;"/><polygon fill="#F1F1F1" points="455.5,50,573.5,50,585.5,62,573.5,74,455.5,74,443.5,62,455.5,50" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="118" x="455.5" y="65.8081">Flag_High_Rpm == 0</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="119" x="324.5" y="59.4058">yes -&gt; Set pwm limit</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="250" x="585.5" y="59.4058">no -&gt; If high rpm, limit pwm by rpm instead</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="108" x="58" y="84"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="88" x="68" y="105.1387">Temp1 = 0xFF</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="171" x="26.5" y="207.77"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="151" x="36.5" y="228.9087">A = Low_Rpm_Pwr_Slope</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="159" x="32.5" y="337.9458"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="139" x="42.5" y="359.0845">A = Comm_Period4x_H</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="70" x="77" y="450.8716"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="50" x="87" y="472.0103">A = 255</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="70" x="77" y="568.2427"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="50" x="87" y="589.3813">A = 127</text><polygon fill="#F1F1F1" points="32,519.8403,192,519.8403,204,531.8403,192,543.8403,32,543.8403,20,531.8403,32,519.8403" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="246" x="116" y="554.0508">yes -&gt; More protection for initial run phase</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="160" x="32" y="535.6484">Flag_Initial_Run_Phase == 1</text><polygon fill="#F1F1F1" points="112,626.6138,124,638.6138,112,650.6138,100,638.6138,112,626.6138" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="159" x="32.5" y="681.7349"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="139" x="42.5" y="702.8735">B = Comm_Period4x_H</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="74" x="75" y="750.7036"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="54" x="85" y="771.8423">A = A / B</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="171" x="26.5" y="832.4771"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="151" x="36.5" y="853.6157">B = Low_Rpm_Pwr_Slope</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="76" x="74" y="886.4458"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="56" x="84" y="907.5845">A = A * B</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="88" x="68" y="1000.2275"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="68" x="78" y="1021.3662">Temp1 = A</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="109" x="57.5" y="1076.9854"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="89" x="67.5" y="1098.124">Exchange A  B</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="104" x="60" y="1200.7554"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="84" x="70" y="1221.894">Temp1 = 255</text><polygon fill="#F1F1F1" points="95,1152.353,129,1152.353,141,1164.353,129,1176.353,95,1176.353,83,1164.353,95,1152.353" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="191" x="116" y="1186.5635">yes -&gt; multiplication result &gt; 255</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="34" x="95" y="1168.1611">A != 0</text><polygon fill="#F1F1F1" points="112,1254.7241,124,1266.7241,112,1278.7241,100,1266.7241,112,1254.7241" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="109" x="57.5" y="1320.123"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="89" x="67.5" y="1341.2617">CARRY_BIT = 0</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="88" x="68" y="1374.0918"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="68" x="78" y="1395.2305">A = Temp1</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="158" x="33" y="1428.0605"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="138" x="43" y="1449.1992">A = A - Pwm_Limit_Beg</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="172" x="26" y="1551.8306"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="152" x="36" y="1572.9692">Temp1 = Pwm_Limit_Beg</text><polygon fill="#F1F1F1" points="65.5,1503.4282,158.5,1503.4282,170.5,1515.4282,158.5,1527.4282,65.5,1527.4282,53.5,1515.4282,65.5,1503.4282" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="20" x="116" y="1537.6387">yes</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="93" x="65.5" y="1519.2363">CARRY_BIT == 1</text><polygon fill="#F1F1F1" points="112,1605.7993,124,1617.7993,112,1629.7993,100,1617.7993,112,1605.7993" style="stroke:#181818;stroke-width:0.5;"/><polygon fill="#F1F1F1" points="95,402.4692,129,402.4692,141,414.4692,129,426.4692,95,426.4692,83,414.4692,95,402.4692" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="227" x="116" y="436.6797">yes -&gt; Divide 255 by Comm_Period4x_H</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="34" x="95" y="418.2773">A != 0</text><polygon fill="#F1F1F1" points="112,1649.7993,124,1661.7993,112,1673.7993,100,1661.7993,112,1649.7993" style="stroke:#181818;stroke-width:0.5;"/><polygon fill="#F1F1F1" points="95,289.5435,129,289.5435,141,301.5435,129,313.5435,95,313.5435,83,301.5435,95,289.5435" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="153" x="116" y="323.7539">yes -&gt; Avoid divide by zero</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="34" x="95" y="305.3516">A != 0</text><polygon fill="#F1F1F1" points="112,1693.7993,124,1705.7993,112,1717.7993,100,1705.7993,112,1693.7993" style="stroke:#181818;stroke-width:0.5;"/><polygon fill="#F1F1F1" points="39.5,159.3677,184.5,159.3677,196.5,171.3677,184.5,183.3677,39.5,183.3677,27.5,171.3677,39.5,159.3677" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="299" x="116" y="193.5781">yes -&gt; Check if low RPM power protection is enabled</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="145" x="39.5" y="175.1758">Flag_Startup_Phase == 0</text><polygon fill="#F1F1F1" points="112,1737.7993,124,1749.7993,112,1761.7993,100,1749.7993,112,1737.7993" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="195" x="14.5" y="1781.7993"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="175" x="24.5" y="1802.938">Pwm_Limit_By_Rpm = Temp1</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="109" x="862.5" y="84"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="89" x="872.5" y="105.1387">CARRY_BIT = 0</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="156" x="839" y="146.563"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="136" x="849" y="167.7017">A = Comm_Period4x_L</text><polygon fill="#F1F1F1" points="865,215.5317,969,215.5317,981,227.5317,969,239.5317,865,239.5317,853,227.5317,865,215.5317" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="104" x="865" y="231.3398">MCU_48MHZ == 1</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="332" x="521" y="224.9375">yes -&gt; Limit Comm_Period4x to 160, which is ~510k erpm</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="326" x="981" y="224.9375">no -&gt; Limit Comm_Period4x to 228, which is ~358k erpm</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="96" x="795" y="249.5317"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="76" x="805" y="270.6704">A = A - 0xA0</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="96" x="943" y="249.5317"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="76" x="953" y="270.6704">A = A - 0xA0</text><polygon fill="#F1F1F1" points="917,289.5005,929,301.5005,917,313.5005,905,301.5005,917,289.5005" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="159" x="837.5" y="348.5005"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="139" x="847.5" y="369.6392">A = Comm_Period4x_H</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="165" x="834.5" y="413.0239"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="145" x="844.5" y="434.1626">A = A - (0 + CARRY_BIT)</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="161" x="836.5" y="481.9927"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="141" x="846.5" y="503.1313">A = Pwm_Limit_By_Rpm</text><polygon fill="#F1F1F1" points="870.5,563.7661,963.5,563.7661,975.5,575.7661,963.5,587.7661,870.5,587.7661,858.5,575.7661,870.5,563.7661" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="93" x="870.5" y="579.5742">CARRY_BIT == 1</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="130" x="728.5" y="573.1719">yes -&gt; above rpm limit</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="123" x="975.5" y="573.1719">no -&gt; below rpm limit</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="74" x="811.5" y="597.7661"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="54" x="821.5" y="618.9048">A = A - 1</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="80" x="945.5" y="597.7661"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="60" x="955.5" y="618.9048">A = A + 1</text><polygon fill="#F1F1F1" points="917,637.7349,929,649.7349,917,661.7349,905,649.7349,917,637.7349" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="161" x="836.5" y="741.2583"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="141" x="846.5" y="762.397">Pwm_Limit_By_Rpm = A</text><polygon fill="#F1F1F1" points="900,692.856,934,692.856,946,704.856,934,716.856,900,716.856,888,704.856,900,692.856" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="20" x="921" y="727.0664">yes</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="34" x="900" y="708.6641">A != 0</text><polygon fill="#F1F1F1" points="917,799.6294,929,811.6294,917,823.6294,905,811.6294,917,799.6294" style="stroke:#181818;stroke-width:0.5;"/><polygon fill="#F1F1F1" points="514.5,1821.7681,526.5,1833.7681,514.5,1845.7681,502.5,1833.7681,514.5,1821.7681" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="38" x="495.5" y="1865.7681"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="18" x="505.5" y="1886.9067">ret</text><ellipse cx="514.5" cy="1930.7368" rx="11" ry="11" style="stroke:#222222;stroke-width:1.0;fill:none;"/><ellipse cx="514.5" cy="1930.7368" fill="#222222" rx="6" ry="6" style="stroke:#111111;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="112" x2="112" y1="543.8403" y2="568.2427"/><polygon fill="#181818" points="108,558.2427,112,568.2427,116,558.2427,112,562.2427" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="204" x2="216" y1="531.8403" y2="531.8403"/><polygon fill="#181818" points="212,575.2271,216,585.2271,220,575.2271,216,579.2271" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="216" x2="216" y1="531.8403" y2="638.6138"/><line style="stroke:#181818;stroke-width:1.0;" x1="216" x2="124" y1="638.6138" y2="638.6138"/><polygon fill="#181818" points="134,634.6138,124,638.6138,134,642.6138,130,638.6138" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="112" x2="112" y1="602.2114" y2="626.6138"/><polygon fill="#181818" points="108,616.6138,112,626.6138,116,616.6138,112,620.6138" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="112" x2="112" y1="484.8403" y2="519.8403"/><polygon fill="#181818" points="108,509.8403,112,519.8403,116,509.8403,112,513.8403" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="112" x2="112" y1="650.6138" y2="681.7349"/><polygon fill="#181818" points="108,671.7349,112,681.7349,116,671.7349,112,675.7349" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="112" x2="112" y1="715.7036" y2="750.7036"/><polygon fill="#181818" points="108,740.7036,112,750.7036,116,740.7036,112,744.7036" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="112" x2="112" y1="784.6724" y2="832.4771"/><polygon fill="#181818" points="108,822.4771,112,832.4771,116,822.4771,112,826.4771" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="94" x="116" y="812.3828">Multiply by slope</text><line style="stroke:#181818;stroke-width:1.0;" x1="112" x2="112" y1="866.4458" y2="886.4458"/><polygon fill="#181818" points="108,876.4458,112,886.4458,116,876.4458,112,880.4458" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="112" x2="112" y1="920.4146" y2="1000.2275"/><polygon fill="#181818" points="108,990.2275,112,1000.2275,116,990.2275,112,994.2275" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="28" x="116" y="941.7192">Now:</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="311" x="124" y="954.5239">BA = (255 / Comm_Period4x_H) * Low_Rpm_Pwr_Slope</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="12" x="124" y="967.3286">or</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="311" x="124" y="980.1333">BA = (127 / Comm_Period4x_H) * Low_Rpm_Pwr_Slope</text><line style="stroke:#181818;stroke-width:1.0;" x1="112" x2="112" y1="1034.1963" y2="1076.9854"/><polygon fill="#181818" points="108,1066.9854,112,1076.9854,116,1066.9854,112,1070.9854" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="214" x="116" y="1056.8911">Put high part of the multiplication in A</text><line style="stroke:#181818;stroke-width:1.0;" x1="112" x2="112" y1="1176.353" y2="1200.7554"/><polygon fill="#181818" points="108,1190.7554,112,1200.7554,116,1190.7554,112,1194.7554" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="141" x2="174" y1="1164.353" y2="1164.353"/><polygon fill="#181818" points="170,1207.7397,174,1217.7397,178,1207.7397,174,1211.7397" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="174" x2="174" y1="1164.353" y2="1266.7241"/><line style="stroke:#181818;stroke-width:1.0;" x1="174" x2="124" y1="1266.7241" y2="1266.7241"/><polygon fill="#181818" points="134,1262.7241,124,1266.7241,134,1270.7241,130,1266.7241" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="112" x2="112" y1="1234.7241" y2="1254.7241"/><polygon fill="#181818" points="108,1244.7241,112,1254.7241,116,1244.7241,112,1248.7241" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="112" x2="112" y1="1110.9541" y2="1152.353"/><polygon fill="#181818" points="108,1142.353,112,1152.353,116,1142.353,112,1146.353" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="317" x="116" y="1132.2588">Now A = high multiplication result part and B = low one</text><line style="stroke:#181818;stroke-width:1.0;" x1="112" x2="112" y1="1278.7241" y2="1320.123"/><polygon fill="#181818" points="108,1310.123,112,1320.123,116,1310.123,112,1314.123" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="216" x="116" y="1300.0288">Pwm_Limit_Beg shall be the minimum</text><line style="stroke:#181818;stroke-width:1.0;" x1="112" x2="112" y1="1354.0918" y2="1374.0918"/><polygon fill="#181818" points="108,1364.0918,112,1374.0918,116,1364.0918,112,1368.0918" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="112" x2="112" y1="1408.0605" y2="1428.0605"/><polygon fill="#181818" points="108,1418.0605,112,1428.0605,116,1418.0605,112,1422.0605" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="112" x2="112" y1="1527.4282" y2="1551.8306"/><polygon fill="#181818" points="108,1541.8306,112,1551.8306,116,1541.8306,112,1545.8306" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="170.5" x2="208" y1="1515.4282" y2="1515.4282"/><polygon fill="#181818" points="204,1558.8149,208,1568.8149,212,1558.8149,208,1562.8149" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="208" x2="208" y1="1515.4282" y2="1617.7993"/><line style="stroke:#181818;stroke-width:1.0;" x1="208" x2="124" y1="1617.7993" y2="1617.7993"/><polygon fill="#181818" points="134,1613.7993,124,1617.7993,134,1621.7993,130,1617.7993" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="112" x2="112" y1="1585.7993" y2="1605.7993"/><polygon fill="#181818" points="108,1595.7993,112,1605.7993,116,1595.7993,112,1599.7993" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="112" x2="112" y1="1462.0293" y2="1503.4282"/><polygon fill="#181818" points="108,1493.4282,112,1503.4282,116,1493.4282,112,1497.4282" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="180" x="116" y="1483.334">check Temp1 &lt; Pwm_Limit_Beg</text><line style="stroke:#181818;stroke-width:1.0;" x1="112" x2="112" y1="426.4692" y2="450.8716"/><polygon fill="#181818" points="108,440.8716,112,450.8716,116,440.8716,112,444.8716" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="141" x2="445" y1="414.4692" y2="414.4692"/><polygon fill="#181818" points="441,1044.1963,445,1054.1963,449,1044.1963,445,1048.1963" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="445" x2="445" y1="414.4692" y2="1661.7993"/><line style="stroke:#181818;stroke-width:1.0;" x1="445" x2="124" y1="1661.7993" y2="1661.7993"/><polygon fill="#181818" points="134,1657.7993,124,1661.7993,134,1665.7993,130,1661.7993" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="112" x2="112" y1="1629.7993" y2="1649.7993"/><polygon fill="#181818" points="108,1639.7993,112,1649.7993,116,1639.7993,112,1643.7993" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="112" x2="112" y1="371.9146" y2="402.4692"/><polygon fill="#181818" points="108,392.4692,112,402.4692,116,392.4692,112,396.4692" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="112" x2="112" y1="313.5435" y2="337.9458"/><polygon fill="#181818" points="108,327.9458,112,337.9458,116,327.9458,112,331.9458" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="141" x2="467" y1="301.5435" y2="301.5435"/><polygon fill="#181818" points="463,1014.7275,467,1024.7275,471,1014.7275,467,1018.7275" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="467" x2="467" y1="301.5435" y2="1705.7993"/><line style="stroke:#181818;stroke-width:1.0;" x1="467" x2="124" y1="1705.7993" y2="1705.7993"/><polygon fill="#181818" points="134,1701.7993,124,1705.7993,134,1709.7993,130,1705.7993" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="112" x2="112" y1="1673.7993" y2="1693.7993"/><polygon fill="#181818" points="108,1683.7993,112,1693.7993,116,1683.7993,112,1687.7993" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="112" x2="112" y1="241.7388" y2="289.5435"/><polygon fill="#181818" points="108,279.5435,112,289.5435,116,279.5435,112,283.5435" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="180" x="116" y="269.4492">Check Low_Rpm_Pwr_Slope &gt; 0</text><line style="stroke:#181818;stroke-width:1.0;" x1="112" x2="112" y1="183.3677" y2="207.77"/><polygon fill="#181818" points="108,197.77,112,207.77,116,197.77,112,201.77" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="196.5" x2="489" y1="171.3677" y2="171.3677"/><polygon fill="#181818" points="485,973.8408,489,983.8408,493,973.8408,489,977.8408" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="489" x2="489" y1="171.3677" y2="1749.7993"/><line style="stroke:#181818;stroke-width:1.0;" x1="489" x2="124" y1="1749.7993" y2="1749.7993"/><polygon fill="#181818" points="134,1745.7993,124,1749.7993,134,1753.7993,130,1749.7993" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="112" x2="112" y1="1717.7993" y2="1737.7993"/><polygon fill="#181818" points="108,1727.7993,112,1737.7993,116,1727.7993,112,1731.7993" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="112" x2="112" y1="117.9688" y2="159.3677"/><polygon fill="#181818" points="108,149.3677,112,159.3677,116,149.3677,112,153.3677" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="137" x="116" y="139.2734">Exit if startup phase set</text><line style="stroke:#181818;stroke-width:1.0;" x1="112" x2="112" y1="1761.7993" y2="1781.7993"/><polygon fill="#181818" points="108,1771.7993,112,1781.7993,116,1771.7993,112,1775.7993" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="917" x2="917" y1="117.9688" y2="146.563"/><polygon fill="#181818" points="913,136.563,917,146.563,921,136.563,917,140.563" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="853" x2="843" y1="227.5317" y2="227.5317"/><line style="stroke:#181818;stroke-width:1.0;" x1="843" x2="843" y1="227.5317" y2="249.5317"/><polygon fill="#181818" points="839,239.5317,843,249.5317,847,239.5317,843,243.5317" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="981" x2="991" y1="227.5317" y2="227.5317"/><line style="stroke:#181818;stroke-width:1.0;" x1="991" x2="991" y1="227.5317" y2="249.5317"/><polygon fill="#181818" points="987,239.5317,991,249.5317,995,239.5317,991,243.5317" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="843" x2="843" y1="283.5005" y2="301.5005"/><line style="stroke:#181818;stroke-width:1.0;" x1="843" x2="905" y1="301.5005" y2="301.5005"/><polygon fill="#181818" points="895,297.5005,905,301.5005,895,305.5005,899,301.5005" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="991" x2="991" y1="283.5005" y2="301.5005"/><line style="stroke:#181818;stroke-width:1.0;" x1="991" x2="929" y1="301.5005" y2="301.5005"/><polygon fill="#181818" points="939,297.5005,929,301.5005,939,305.5005,935,301.5005" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="917" x2="917" y1="180.5317" y2="215.5317"/><polygon fill="#181818" points="913,205.5317,917,215.5317,921,205.5317,917,209.5317" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="917" x2="917" y1="313.5005" y2="348.5005"/><polygon fill="#181818" points="913,338.5005,917,348.5005,921,338.5005,917,342.5005" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="917" x2="917" y1="382.4692" y2="413.0239"/><polygon fill="#181818" points="913,403.0239,917,413.0239,921,403.0239,917,407.0239" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="917" x2="917" y1="446.9927" y2="481.9927"/><polygon fill="#181818" points="913,471.9927,917,481.9927,921,471.9927,917,475.9927" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="858.5" x2="848.5" y1="575.7661" y2="575.7661"/><line style="stroke:#181818;stroke-width:1.0;" x1="848.5" x2="848.5" y1="575.7661" y2="597.7661"/><polygon fill="#181818" points="844.5,587.7661,848.5,597.7661,852.5,587.7661,848.5,591.7661" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="975.5" x2="985.5" y1="575.7661" y2="575.7661"/><line style="stroke:#181818;stroke-width:1.0;" x1="985.5" x2="985.5" y1="575.7661" y2="597.7661"/><polygon fill="#181818" points="981.5,587.7661,985.5,597.7661,989.5,587.7661,985.5,591.7661" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="848.5" x2="848.5" y1="631.7349" y2="649.7349"/><line style="stroke:#181818;stroke-width:1.0;" x1="848.5" x2="905" y1="649.7349" y2="649.7349"/><polygon fill="#181818" points="895,645.7349,905,649.7349,895,653.7349,899,649.7349" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="985.5" x2="985.5" y1="631.7349" y2="649.7349"/><line style="stroke:#181818;stroke-width:1.0;" x1="985.5" x2="929" y1="649.7349" y2="649.7349"/><polygon fill="#181818" points="939,645.7349,929,649.7349,939,653.7349,935,649.7349" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="917" x2="917" y1="515.9614" y2="563.7661"/><polygon fill="#181818" points="913,553.7661,917,563.7661,921,553.7661,917,557.7661" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="335" x="921" y="543.6719">Check Comm_Period4x_H::Comm_Period4x_L &lt; limit above</text><line style="stroke:#181818;stroke-width:1.0;" x1="917" x2="917" y1="716.856" y2="741.2583"/><polygon fill="#181818" points="913,731.2583,917,741.2583,921,731.2583,917,735.2583" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="946" x2="1007.5" y1="704.856" y2="704.856"/><polygon fill="#181818" points="1003.5,748.2427,1007.5,758.2427,1011.5,748.2427,1007.5,752.2427" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1007.5" x2="1007.5" y1="704.856" y2="811.6294"/><line style="stroke:#181818;stroke-width:1.0;" x1="1007.5" x2="929" y1="811.6294" y2="811.6294"/><polygon fill="#181818" points="939,807.6294,929,811.6294,939,815.6294,935,811.6294" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="917" x2="917" y1="775.2271" y2="799.6294"/><polygon fill="#181818" points="913,789.6294,917,799.6294,921,789.6294,917,793.6294" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="917" x2="917" y1="661.7349" y2="692.856"/><polygon fill="#181818" points="913,682.856,917,692.856,921,682.856,917,686.856" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="443.5" x2="112" y1="62" y2="62"/><line style="stroke:#181818;stroke-width:1.0;" x1="112" x2="112" y1="62" y2="84"/><polygon fill="#181818" points="108,74,112,84,116,74,112,78" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="585.5" x2="917" y1="62" y2="62"/><line style="stroke:#181818;stroke-width:1.0;" x1="917" x2="917" y1="62" y2="84"/><polygon fill="#181818" points="913,74,917,84,921,74,917,78" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="112" x2="112" y1="1815.7681" y2="1833.7681"/><line style="stroke:#181818;stroke-width:1.0;" x1="112" x2="502.5" y1="1833.7681" y2="1833.7681"/><polygon fill="#181818" points="492.5,1829.7681,502.5,1833.7681,492.5,1837.7681,496.5,1833.7681" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="917" x2="917" y1="823.6294" y2="1833.7681"/><line style="stroke:#181818;stroke-width:1.0;" x1="917" x2="526.5" y1="1833.7681" y2="1833.7681"/><polygon fill="#181818" points="536.5,1829.7681,526.5,1833.7681,536.5,1837.7681,532.5,1833.7681" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="514.5" x2="514.5" y1="30" y2="50"/><polygon fill="#181818" points="510.5,40,514.5,50,518.5,40,514.5,44" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="514.5" x2="514.5" y1="1845.7681" y2="1865.7681"/><polygon fill="#181818" points="510.5,1855.7681,514.5,1865.7681,518.5,1855.7681,514.5,1859.7681" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="514.5" x2="514.5" y1="1899.7368" y2="1919.7368"/><polygon fill="#181818" points="510.5,1909.7368,514.5,1919.7368,518.5,1909.7368,514.5,1913.7368" style="stroke:#181818;stroke-width:1.0;"/><!--MD5=[6275b4f1c654ff9255312779a598996d]
@startuml 
start
if (Flag_High_Rpm == 0) then
  ->yes -> Set pwm limit;
  :Temp1 = 0xFF;
  ->Exit if startup phase set;
  if (Flag_Startup_Phase == 0) then
    ->yes -> Check if low RPM power protection is enabled;
    :A = Low_Rpm_Pwr_Slope;
    ->Check Low_Rpm_Pwr_Slope > 0;
    if (A != 0) then
      ->yes -> Avoid divide by zero;
      :A = Comm_Period4x_H;
      if (A != 0) then
        ->yes -> Divide 255 by Comm_Period4x_H;
        :A = 255;
        if (Flag_Initial_Run_Phase == 1) then
          ->yes -> More protection for initial run phase;
          :A = 127;
        endif
        :B = Comm_Period4x_H;
        :A = A / B;
        ->Multiply by slope;
        :B = Low_Rpm_Pwr_Slope;
        :A = A * B;
        ->Now:
          BA = (255 / Comm_Period4x_H) * Low_Rpm_Pwr_Slope
          or
          BA = (127 / Comm_Period4x_H) * Low_Rpm_Pwr_Slope;
        :Temp1 = A;
        ->Put high part of the multiplication in A;
        :Exchange A  B;
        ->Now A = high multiplication result part and B = low one;
        if (A != 0) then
          ->yes -> multiplication result > 255;
          :Temp1 = 255;
        endif
        ->Pwm_Limit_Beg shall be the minimum;
        :CARRY_BIT = 0;
        :A = Temp1;
        :A = A - Pwm_Limit_Beg;
        ->check Temp1 < Pwm_Limit_Beg;
        if (CARRY_BIT == 1) then (yes)
          :Temp1 = Pwm_Limit_Beg;
        endif
      endif
    endif
  endif
  :Pwm_Limit_By_Rpm = Temp1;
else
  ->no -> If high rpm, limit pwm by rpm instead;
  :CARRY_BIT = 0;
  :A = Comm_Period4x_L;
  if (MCU_48MHZ == 1) then
    ->yes -> Limit Comm_Period4x to 160, which is ~510k erpm;
    :A = A - 0xA0;
  else
    ->no -> Limit Comm_Period4x to 228, which is ~358k erpm;
    :A = A - 0xA0;
  endif
  :A = Comm_Period4x_H;
  :A = A - (0 + CARRY_BIT);
  
  :A = Pwm_Limit_By_Rpm;
  ->Check Comm_Period4x_H::Comm_Period4x_L < limit above;
  if (CARRY_BIT == 1) then
    ->yes -> above rpm limit;
    :A = A - 1;
  else
    ->no -> below rpm limit;
    :A = A + 1;
  endif
  if (A != 0) then (yes)
    :Pwm_Limit_By_Rpm = A;
  endif
endif
:ret;
stop
@enduml

PlantUML version 1.2022.6(Tue Jun 21 17:34:49 UTC 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: null
--></g></svg>